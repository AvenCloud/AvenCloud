# Migration `20201125071140-site-invites`

This migration has been generated by Eric Vicenti at 11/24/2020, 11:11:40 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE "SiteRoleInvitation" (
"id" SERIAL,
    "inviteTime" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "siteId" INTEGER NOT NULL,
    "recipientUserId" INTEGER,
    "fromUserId" INTEGER NOT NULL,
    "acceptedTime" TIMESTAMP(3),
    "dismissTime" TIMESTAMP(3),
    "name" TEXT NOT NULL,
    "toEmail" TEXT,

    PRIMARY KEY ("id")
)

CREATE UNIQUE INDEX "SiteRoleInviteUnique" ON "SiteRoleInvitation"("siteId", "recipientUserId", "toEmail")

ALTER TABLE "SiteRoleInvitation" ADD FOREIGN KEY("siteId")REFERENCES "Site"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "SiteRoleInvitation" ADD FOREIGN KEY("recipientUserId")REFERENCES "User"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "SiteRoleInvitation" ADD FOREIGN KEY("fromUserId")REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20201117070640-roles..20201125071140-site-invites
--- datamodel.dml
+++ datamodel.dml
@@ -1,7 +1,7 @@
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider = "prisma-client-js"
@@ -26,8 +26,10 @@
   EmailValidation EmailValidation[]
   VerifiedEmail   VerifiedEmail[]
   SiteRole        SiteRole[]
   NodeRole        NodeRole[]
+  SiteInvite      SiteRoleInvitation[] @relation("InviteSenderRelation")
+  SiteInviteSent  SiteRoleInvitation[] @relation("InviteRecipientRelation")
 }
 model EmailValidation {
   id        Int      @id @default(autoincrement())
@@ -68,10 +70,11 @@
   name    String @unique
   ownerId Int
   owner   User   @relation(fields: [ownerId], references: [id])
-  SiteNode SiteNode[]
-  SiteRole SiteRole[]
+  SiteNode           SiteNode[]
+  SiteRole           SiteRole[]
+  SiteRoleInvitation SiteRoleInvitation[]
 }
 model SiteNode {
   id           Int       @id @default(autoincrement())
@@ -104,11 +107,28 @@
   siteId Int
   site   Site   @relation(fields: [siteId], references: [id])
   userId Int
   user   User   @relation(fields: [userId], references: [id])
-  name   String
+  name   String // 
 }
+model SiteRoleInvitation {
+  id              Int       @id @default(autoincrement())
+  inviteTime      DateTime  @default(now())
+  siteId          Int
+  site            Site      @relation(fields: [siteId], references: [id])
+  recipientUserId Int?
+  recipientUser   User?     @relation("InviteRecipientRelation", fields: [recipientUserId], references: [id])
+  fromUserId      Int
+  fromUser        User      @relation("InviteSenderRelation", fields: [fromUserId], references: [id])
+  acceptedTime    DateTime?
+  dismissTime     DateTime?
+  name            String // this is the eventual SiteRole.name
+  toEmail         String?
+
+  @@unique([siteId, recipientUserId, toEmail], name: "SiteRoleInviteUnique")
+}
+
 // ClipClock
 model Clip {
   id          Int       @id @default(autoincrement())
```


